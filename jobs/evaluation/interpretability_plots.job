#!/bin/bash
#SBATCH --partition=gpu_h100
#SBATCH --gpus=1
#SBATCH --job-name=interp-plots
#SBATCH --output=/scratch-shared/pnair/Project_AI/jobs/outputs/evaluation/interpretability_plots.log
#SBATCH --time=6:00:00
#SBATCH --cpus-per-task=8
#SBATCH --mem=64G

# ============================================
# JOB: Interpretability Plots (Full Analysis)
# ============================================
# This job runs full interpretability analysis on Stage 2 models:
# - Loads checkpoints and runs inference on test split
# - Generates error maps (pointwise, cell-aggregated)
# - Creates ablation comparisons (CDF, delta maps)
#
# Use this when you want:
# - Per-sample predictions (saved to CSV)
# - All interpretability plots (errors, comparisons, worst cases)
#
# QUICK ALTERNATIVE:
# Use 'visualize_geocells.job' for just geocell maps
# (no model loading, just cell_centers from checkpoints)
#
# Usage:
#   sbatch jobs/evaluation/interpretability_plots.job
#
# With custom config:
#   SPLITS_JSON=path/to/splits.json \
#   CSV_PATH=path/to/dataset.csv \
#   SPLIT=test \
#   sbatch jobs/evaluation/interpretability_plots.job
#
# With custom output directory:
#   OUTPUT_DIR=results/my_output \
#   sbatch jobs/evaluation/interpretability_plots.job
# ============================================

# Activate environment
module load 2025
module load Anaconda3/2025.06-1
cd /scratch-shared/pnair/Project_AI/
module load CUDA/12.8.0

source activate streetview_pnair
export PYTHONNOUSERSITE=1
export PYTHONPATH=/scratch-shared/pnair/Project_AI:$PYTHONPATH
# Ensure the activated env's python is used (module Anaconda may appear earlier in PATH)
export PATH="$CONDA_PREFIX/bin:$PATH"

# Configuration
SPLITS_JSON="${SPLITS_JSON:-/scratch-shared/pnair/Project_AI/results/stage1-prototype/vanilla_streetclip_no_stage0/2025-12-21_10-48-19/splits.json}"
CSV_PATH="${CSV_PATH:-data/dataset-43k-mapped.csv}"
DATA_ROOT="${DATA_ROOT:-/scratch-shared/pnair/Project_AI/data}"
GEOGUESSR_ID="${GEOGUESSR_ID:-6906237dc7731161a37282b2}"
RESULTS_ROOT="${RESULTS_ROOT:-results}"
SPLIT="${SPLIT:-test}"
OUTPUT_DIR="${OUTPUT_DIR:-}"

echo "============================================="
echo "Interpretability Plots Generation"
echo "============================================="
echo "Batch mode: Auto-detecting latest Stage 2 checkpoints"
echo "Results root: $RESULTS_ROOT"
echo "Using splits: $SPLITS_JSON"
echo "CSV path: $CSV_PATH"
echo "Split: $SPLIT"
echo "Output dir: ${OUTPUT_DIR:-default}"
echo "============================================="

# Build command
CMD="python scripts/analysis/interpretability_plots.py \
    --batch_mode \
    --results_root \"$RESULTS_ROOT\" \
    --csv_path \"$CSV_PATH\" \
    --splits_json \"$SPLITS_JSON\" \
    --data_root \"$DATA_ROOT\" \
    --geoguessr_id \"$GEOGUESSR_ID\" \
    --batch_size 32 \
    --num_workers 8 \
    --split $SPLIT"

# Add output_dir if specified
if [ -n "$OUTPUT_DIR" ]; then
    CMD="$CMD --output_dir \"$OUTPUT_DIR\""
fi

# Execute
eval $CMD

echo ""
echo "============================================="
echo "Interpretability plots generation complete!"
echo "Check output directory: $RESULTS_ROOT/interpretability/"
echo "============================================="

